name: Deploy static site to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug list static files
        run: |
          echo "Listing static directory contents"
          ls -al src/main/resources/static || true
          echo "HTML files under static:" || true
          find src/main/resources/static -maxdepth 1 -type f -name "*.html" -print | sort || true
      - name: Verify required pages exist
        run: |
          for f in index.html booking.html checkout.html 404.html; do
            if [ ! -f "src/main/resources/static/$f" ]; then
              echo "ERROR: Missing required page: $f" >&2
              exit 1
            fi
          done
      - name: Write on-site file listing for debug
        run: |
          echo "Creating FILES.txt and CHECK.html for published site debug"
          echo "Files under static (recursive):" > src/main/resources/static/FILES.txt
          find src/main/resources/static -type f | sort >> src/main/resources/static/FILES.txt
          cat > src/main/resources/static/CHECK.html <<'HTML'
          <!doctype html><html><head><meta charset="utf-8"><title>CHECK</title></head>
          <body><h1>Deployed file list</h1><p>See <a href="FILES.txt">FILES.txt</a></p>
          <ul>
            <li><a href="index.html">index.html</a></li>
            <li><a href="booking.html">booking.html</a></li>
            <li><a href="checkout.html">checkout.html</a></li>
            <li><a href="404.html">404.html</a></li>
          </ul></body></html>
          HTML
      - name: Generate responsive images
        run: |
          sudo apt-get update -y
          sudo apt-get install -y imagemagick
          cd src/main/resources/static/assets/image
          if [ -f Beach4.jpg ]; then
            convert Beach4.jpg -resize 480x -quality 82 Beach4-480.jpg
            convert Beach4.jpg -resize 768x -quality 85 Beach4-768.jpg
          fi
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: src/main/resources/static
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
